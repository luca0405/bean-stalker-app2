require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '14.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorNativeBiometric', :path => '../../node_modules/capacitor-native-biometric'
  pod 'RevenuecatPurchasesCapacitor', :path => '../../node_modules/@revenuecat/purchases-capacitor'
end

target 'App' do
  capacitor_pods
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      # iOS 14.0 for Capacitor compatibility
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
      
      # Older MacBook compatibility
      config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
      config.build_settings['VALID_ARCHS'] = 'x86_64'
      config.build_settings['ARCHS'] = 'x86_64'
      
      # Swift/C++ settings
      config.build_settings['SWIFT_VERSION'] = '5.0'
      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'gnu++14'
      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
      
      # MSEC_PER_SEC fix
      preprocessor_defs = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] || ['$(inherited)']
      preprocessor_defs = [preprocessor_defs] unless preprocessor_defs.is_a?(Array)
      has_msec_def = preprocessor_defs.any? { |definition| definition.include?('MSEC_PER_SEC') }
      preprocessor_defs << 'MSEC_PER_SEC=1000' unless has_msec_def
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = preprocessor_defs
      
      # Remove bridging header references
      config.build_settings.delete('SWIFT_OBJC_BRIDGING_HEADER')
      
      # Optimization settings
      config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
    end
  end
end